<script>
        function initAstro() {
            const dash = document.getElementById('sky-dashboard');
            
            // Reset UI to loading state
            dash.innerHTML = '<div class="loading-text">Acquiring position for astronomy data...</div>';

            if (!navigator.geolocation) { 
                dash.innerHTML = '<div style="color:#f87171; text-align:center;">Geolocation not supported by this browser.</div>'; 
                return; 
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                
                try {
                    // Fetch Data from Open-Meteo Astronomy Endpoint
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=sunrise,sunset,daylight_duration,moon_phase&timezone=auto&forecast_days=1`;
                    
                    console.log("Fetching Astro Data from:", url); // Debug Log
                    
                    const res = await fetch(url);
                    
                    // CHECK 1: Did the server respond okay?
                    if (!res.ok) {
                        throw new Error(`API Error: ${res.status} ${res.statusText}`);
                    }

                    const data = await res.json();
                    
                    // CHECK 2: Do we have the data we need?
                    if (!data.daily || !data.daily.sunrise) {
                        throw new Error("Incomplete data received from weather provider.");
                    }

                    const day = data.daily;

                    // Helper to format time safely
                    const fmt = (isoStr) => {
                        if (!isoStr) return "--:--";
                        const date = new Date(isoStr);
                        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    };

                    // Moon Phase Logic (0-1 scale)
                    const mp = day.moon_phase ? day.moon_phase[0] : 0.5;
                    let moonText = "Waxing";
                    let moonIcon = "üåì";
                    if(mp === 0 || mp === 1) { moonText = "New Moon"; moonIcon = "üåë"; }
                    else if(mp === 0.5) { moonText = "Full Moon"; moonIcon = "üåï"; }
                    else if(mp < 0.5) { moonText = "Waxing"; moonIcon = "üåì"; }
                    else { moonText = "Waning"; moonIcon = "üåó"; }

                    // Daylight calc (Safe Math)
                    const duration = day.daylight_duration ? day.daylight_duration[0] : 0;
                    const hours = Math.floor(duration / 3600);
                    const mins = Math.floor((duration % 3600) / 60);

                    // Render Dashboard
                    dash.innerHTML = `
                        <div class="sky-item">
                            <div class="sky-label">üåÖ Sunrise</div>
                            <div class="sky-val" style="color:#fbbf24">${fmt(day.sunrise[0])}</div>
                        </div>
                        <div class="sky-item">
                            <div class="sky-label">üåá Sunset</div>
                            <div class="sky-val" style="color:#f87171">${fmt(day.sunset[0])}</div>
                        </div>
                        <div class="sky-item">
                            <div class="sky-label">‚òÄÔ∏è Day Length</div>
                            <div class="sky-val">${hours}h ${mins}m</div>
                        </div>
                        <div class="sky-item">
                            <div class="sky-label">${moonIcon} Moon Phase</div>
                            <div class="sky-val" style="font-size:16px; margin-top:4px;">${moonText}</div>
                        </div>
                    `;

                } catch (e) {
                    console.error("Astro Error:", e);
                    dash.innerHTML = `
                        <div style="color:#f87171; font-size:13px; text-align:center; grid-column: 1 / -1;">
                            <strong>Data Unavailable</strong><br>
                            <span style="font-size:11px; opacity:0.8;">${e.message}</span>
                            <br>
                            <button onclick="initAstro()" style="margin-top:10px; padding:6px 12px; background:rgba(255,255,255,0.1); color:white; border:1px solid rgba(255,255,255,0.2); border-radius:4px; cursor:pointer;">
                                ‚Üª Retry Connection
                            </button>
                        </div>
                    `;
                }

            }, (err) => {
                console.error("Geo Error:", err);
                let msg = "Location Access Denied";
                if(err.code === 2) msg = "Position Unavailable (Check GPS)";
                if(err.code === 3) msg = "Location Request Timed Out";
                
                dash.innerHTML = `<div style="color:#f87171; text-align:center;">${msg}</div>`;
            }, { timeout: 10000, enableHighAccuracy: false }); // Relaxed GPS requirements for better success rate
        }

        // Run on load
        initAstro();
    </script>
